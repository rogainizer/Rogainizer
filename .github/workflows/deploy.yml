name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install root dependencies
        run: npm install

      - name: Install backend dependencies
        run: npm install
        working-directory: backend

      - name: Install frontend dependencies
        run: npm install
        working-directory: frontend

      - name: Build frontend assets
        run: npm run build
        working-directory: frontend

      - name: Deploy to droplet
        uses: appleboy/ssh-action@v1.0.4
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: root
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            cd /opt/rogainizer
            git fetch origin main
            git reset --hard origin/main
            docker compose --env-file .env.production -f docker-compose.prod.yml pull
            docker compose --env-file .env.production -f docker-compose.prod.yml up -d --build
            docker compose --env-file .env.production -f docker-compose.prod.yml exec -T api npm run db:init
            POSTDEPLOY_LOG="deploy/postdeploy-last.log"
            POSTDEPLOY_STATUS_FILE="deploy/postdeploy-status.txt"
            chmod +x deploy/postdeploy-check.sh
            set +e
            ./deploy/postdeploy-check.sh .env.production | tee "$POSTDEPLOY_LOG"
            POSTDEPLOY_EXIT=${PIPESTATUS[0]}
            echo "$POSTDEPLOY_EXIT" > "$POSTDEPLOY_STATUS_FILE"
            set -e
            if [ "$POSTDEPLOY_EXIT" -ne 0 ]; then
              echo "postdeploy-check failed"
              exit "$POSTDEPLOY_EXIT"
            fi

      - name: Download postdeploy artifacts
        if: always()
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: root
          key: ${{ secrets.DROPLET_SSH_KEY }}
          source: "/opt/rogainizer/deploy/postdeploy-last.log,/opt/rogainizer/deploy/postdeploy-status.txt"
          target: "postdeploy"

      - name: Prepare email body
        if: always()
        id: postdeploy_log
        run: |
          body=$(cat postdeploy/postdeploy-last.log)
          body="${body//'%'/'%25'}"
          body="${body//$'\n'/'%0A'}"
          echo "body=$body" >> "$GITHUB_OUTPUT"
          status=$(cat postdeploy/postdeploy-status.txt)
          echo "status=$status" >> "$GITHUB_OUTPUT"

      - name: Email postdeploy result
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Rogainizer postdeploy (status: ${{ steps.postdeploy_log.outputs.status }})"
          to: rogainizer.nz@gmail.com
          from: Rogainizer CI <${{ secrets.SMTP_USERNAME }}>
          body: ${{ steps.postdeploy_log.outputs.body }}
