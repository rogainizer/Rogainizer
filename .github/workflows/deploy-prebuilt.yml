name: Production Deploy

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  API_IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/rogainizer-api
  WEB_IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/rogainizer-web
  LATEST_TAG: latest

jobs:
  build-and-deploy:
    name: Build images locally and deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build backend and frontend images locally
        env:
          API_IMAGE: ${{ env.API_IMAGE_NAME }}:${{ env.LATEST_TAG }}
          WEB_IMAGE: ${{ env.WEB_IMAGE_NAME }}:${{ env.LATEST_TAG }}
        run: docker compose -f docker-compose.prod.yml build api web

      - name: Tag images with commit SHA
        run: |
          docker tag ${{ env.API_IMAGE_NAME }}:${{ env.LATEST_TAG }} ${{ env.API_IMAGE_NAME }}:${{ github.sha }}
          docker tag ${{ env.WEB_IMAGE_NAME }}:${{ env.LATEST_TAG }} ${{ env.WEB_IMAGE_NAME }}:${{ github.sha }}

      - name: Push images to GitHub Container Registry
        run: |
          docker push ${{ env.API_IMAGE_NAME }}:${{ env.LATEST_TAG }}
          docker push ${{ env.API_IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.WEB_IMAGE_NAME }}:${{ env.LATEST_TAG }}
          docker push ${{ env.WEB_IMAGE_NAME }}:${{ github.sha }}

      - name: Deploy pre-built images to droplet
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: root
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script_stop: true
          command_timeout: 1800s
          script: |
            set -euo pipefail
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin
            cd /opt/rogainizer
            git fetch origin main
            git reset --hard origin/main
            export API_IMAGE="${{ env.API_IMAGE_NAME }}:${{ env.LATEST_TAG }}"
            export WEB_IMAGE="${{ env.WEB_IMAGE_NAME }}:${{ env.LATEST_TAG }}"
            API_IMAGE="$API_IMAGE" WEB_IMAGE="$WEB_IMAGE" docker compose --env-file .env.production -f docker-compose.prod.yml pull api web
            API_IMAGE="$API_IMAGE" WEB_IMAGE="$WEB_IMAGE" docker compose --env-file .env.production -f docker-compose.prod.yml up -d
            API_IMAGE="$API_IMAGE" WEB_IMAGE="$WEB_IMAGE" docker compose --env-file .env.production -f docker-compose.prod.yml exec -T api npm run db:init
            POSTDEPLOY_LOG="deploy/postdeploy-last.log"
            POSTDEPLOY_STATUS_FILE="deploy/postdeploy-status.txt"
            mkdir -p deploy
            : > "$POSTDEPLOY_LOG"
            : > "$POSTDEPLOY_STATUS_FILE"
            chmod +x deploy/postdeploy-check.sh
            set +e
            API_IMAGE="$API_IMAGE" WEB_IMAGE="$WEB_IMAGE" ./deploy/postdeploy-check.sh .env.production > "$POSTDEPLOY_LOG" 2>&1
            POSTDEPLOY_EXIT=$?
            cat "$POSTDEPLOY_LOG"
            echo "$POSTDEPLOY_EXIT" > "$POSTDEPLOY_STATUS_FILE"
            set -e
            if [ "$POSTDEPLOY_EXIT" -ne 0 ]; then
              echo "postdeploy-check failed"
              exit "$POSTDEPLOY_EXIT"
            fi

      - name: Download postdeploy artifacts
        if: always()
        env:
          DROPLET_IP: ${{ secrets.DROPLET_IP }}
          DROPLET_SSH_KEY: ${{ secrets.DROPLET_SSH_KEY }}
        run: |
          set -euo pipefail
          mkdir -p postdeploy
          mkdir -p ~/.ssh
          KEY_FILE=~/.ssh/rogainizer_deploy_key
          printf '%s\n' "$DROPLET_SSH_KEY" | tr -d '\r' > "$KEY_FILE"
          chmod 600 "$KEY_FILE"
          scp -i "$KEY_FILE" -o StrictHostKeyChecking=no root@"$DROPLET_IP":/opt/rogainizer/deploy/postdeploy-last.log postdeploy/
          scp -i "$KEY_FILE" -o StrictHostKeyChecking=no root@"$DROPLET_IP":/opt/rogainizer/deploy/postdeploy-status.txt postdeploy/
          rm -f "$KEY_FILE"

      - name: Prepare email body
        if: always()
        id: postdeploy_log
        run: |
          log_file="postdeploy/postdeploy-last.log"
          status_file="postdeploy/postdeploy-status.txt"
          if [ -f "$status_file" ]; then
            status=$(tr -d '\r' < "$status_file" | tr -d '\n')
          else
            status="unknown"
          fi
          if [ -z "$status" ]; then
            status="unknown"
          fi
          echo "status=$status" >> "$GITHUB_OUTPUT"
          mkdir -p postdeploy
          {
            echo "Postdeploy check status: $status"
            echo
            cat "$log_file"
          } > postdeploy/email-body.txt

      - name: Email postdeploy result
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Rogainizer prebuilt postdeploy (status: ${{ steps.postdeploy_log.outputs.status }})"
          to: rogainizer.nz@gmail.com
          from: Rogainizer CI <${{ secrets.SMTP_USERNAME }}>
          body_path: postdeploy/email-body.txt
