#cloud-config
package_update: true
package_upgrade: true
packages:
  - ca-certificates
  - curl
  - gnupg
  - ufw

write_files:
  - path: /usr/local/bin/rogainizer-bootstrap.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      if ! command -v docker >/dev/null 2>&1; then
        curl -fsSL https://get.docker.com | sh
      fi

      DEFAULT_USER="root"
      if id -u ubuntu >/dev/null 2>&1; then
        DEFAULT_USER="ubuntu"
      else
        FIRST_USER="$(getent passwd 1000 | cut -d: -f1 || true)"
        if [[ -n "$FIRST_USER" ]]; then
          DEFAULT_USER="$FIRST_USER"
        fi
      fi

      systemctl enable docker
      systemctl start docker

      if [[ "$DEFAULT_USER" != "root" ]]; then
        if id -nG "$DEFAULT_USER" | grep -qw docker; then
          :
        else
          usermod -aG docker "$DEFAULT_USER"
        fi
      fi

      ufw allow OpenSSH
      ufw allow 80
      ufw allow 443
      ufw --force enable

      timedatectl set-timezone Pacific/Auckland || true

runcmd:
  - [ bash, -lc, '/usr/local/bin/rogainizer-bootstrap.sh > /var/log/rogainizer-bootstrap.log 2>&1' ]

final_message: "Rogainizer cloud-init complete. Reconnect SSH, then deploy the app from /opt/rogainizer instructions."