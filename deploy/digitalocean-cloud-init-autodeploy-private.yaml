#cloud-config
package_update: true
package_upgrade: true
packages:
  - ca-certificates
  - curl
  - gnupg
  - git
  - ufw

write_files:
  - path: /usr/local/bin/rogainizer-autodeploy-private.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      REPO_URL="git@github.com:your-org/your-private-repo.git"
      REPO_REF="main"
      APP_DIR="/opt/rogainizer"

      DOMAIN="example.com"
      MYSQL_ROOT_PASSWORD="replace-with-strong-root-password"
      DB_USER="root"
      DB_PASSWORD="replace-with-strong-db-password"
      DB_NAME="rogainizer"

      GITHUB_DEPLOY_KEY_BASE64="replace-with-base64-private-key"

      DEFAULT_USER="root"
      if id -u ubuntu >/dev/null 2>&1; then
        DEFAULT_USER="ubuntu"
      else
        FIRST_USER="$(getent passwd 1000 | cut -d: -f1 || true)"
        if [[ -n "$FIRST_USER" ]]; then
          DEFAULT_USER="$FIRST_USER"
        fi
      fi

      if [[ "$REPO_URL" == "git@github.com:your-org/your-private-repo.git" ]]; then
        echo "REPO_URL is still placeholder. Edit deploy/digitalocean-cloud-init-autodeploy-private.yaml before use."
        exit 1
      fi

      if [[ "$GITHUB_DEPLOY_KEY_BASE64" == "replace-with-base64-private-key" ]]; then
        echo "GITHUB_DEPLOY_KEY_BASE64 is still placeholder. Edit deploy/digitalocean-cloud-init-autodeploy-private.yaml before use."
        exit 1
      fi

      if ! command -v docker >/dev/null 2>&1; then
        curl -fsSL https://get.docker.com | sh
      fi

      systemctl enable docker
      systemctl start docker

      if [[ "$DEFAULT_USER" != "root" ]]; then
        if id -nG "$DEFAULT_USER" | grep -qw docker; then
          :
        else
          usermod -aG docker "$DEFAULT_USER"
        fi
      fi

      ufw allow OpenSSH
      ufw allow 80
      ufw allow 443
      ufw --force enable

      timedatectl set-timezone Pacific/Auckland || true

      SSH_HOME="$(getent passwd "$DEFAULT_USER" | cut -d: -f6)"
      if [[ -z "$SSH_HOME" ]]; then
        SSH_HOME="/root"
      fi

      install -d -m 700 -o "$DEFAULT_USER" -g "$DEFAULT_USER" "$SSH_HOME/.ssh"
      echo "$GITHUB_DEPLOY_KEY_BASE64" | base64 -d > "$SSH_HOME/.ssh/id_ed25519"
      chmod 600 "$SSH_HOME/.ssh/id_ed25519"
      chown "$DEFAULT_USER:$DEFAULT_USER" "$SSH_HOME/.ssh/id_ed25519"
      touch "$SSH_HOME/.ssh/known_hosts"
      chmod 644 "$SSH_HOME/.ssh/known_hosts"
      chown "$DEFAULT_USER:$DEFAULT_USER" "$SSH_HOME/.ssh/known_hosts"
      ssh-keyscan -t rsa,ecdsa,ed25519 github.com >> "$SSH_HOME/.ssh/known_hosts"

      mkdir -p /opt

      export GIT_SSH_COMMAND="ssh -i $SSH_HOME/.ssh/id_ed25519 -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes"

      if [[ ! -d "$APP_DIR/.git" ]]; then
        git clone "$REPO_URL" "$APP_DIR"
      fi

      cd "$APP_DIR"
      git fetch --all --prune
      git checkout "$REPO_REF"
      git pull --ff-only origin "$REPO_REF"

      cat > .env.production <<EOF
      DOMAIN=${DOMAIN}
      MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      DB_USER=${DB_USER}
      DB_PASSWORD=${DB_PASSWORD}
      DB_NAME=${DB_NAME}
      EOF

      docker compose --env-file .env.production -f docker-compose.prod.yml up -d --build

      for attempt in 1 2 3 4 5; do
        if docker compose --env-file .env.production -f docker-compose.prod.yml exec -T api npm run db:init; then
          break
        fi

        if [[ "$attempt" == "5" ]]; then
          echo "db:init failed after retries"
          exit 1
        fi

        sleep 8
      done

      chmod +x ./deploy/postdeploy-check.sh || true
      ./deploy/postdeploy-check.sh .env.production || true
      chmod +x ./deploy/first-boot-report.sh || true
      ./deploy/first-boot-report.sh .env.production /var/log/rogainizer-report.txt || true

runcmd:
  - [ bash, -lc, '/usr/local/bin/rogainizer-autodeploy-private.sh > /var/log/rogainizer-autodeploy.log 2>&1' ]

final_message: "Rogainizer private-repo autodeploy cloud-init complete. Check /var/log/rogainizer-autodeploy.log"